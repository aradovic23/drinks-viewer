import { type NextPage } from "next";
import { useRouter } from "next/router";
import { api } from "../../utils/api";
import { toast } from "react-toastify";
import EditDrinkForm from "../../components/EditDrinkForm";
import Head from "next/head";
import { useSession } from "next-auth/react";
import AccessDenied from "../../components/AccessDenied";
import Spinner from "../../components/Spinner";
import { useGetCategory } from "../../hooks/useGetCategory";

export type TDrink = {
  id?: string;
  title?: string;
  price?: string;
  volume?: string;
  type?: string;
  tag?: string;
  categoryID?: number;
  createdDate?: Date;
  description?: string;
  updatedAt?: Date;
};

const EditDrinkPage: NextPage = () => {
  const { data: sessionData, status } = useSession();

  const router = useRouter();
  const { id } = router.query as {
    id: string;
  };
  const { data } = api.drinks.getDrinkById.useQuery<{
    id: number;
    categoryId: number;
  }>(
    { id },
    {
      refetchOnWindowFocus: false,
    }
  );

  const utils = api.useContext();
  const updateSingleDrink = api.drinks.updateDrink.useMutation();
  const { category } = useGetCategory(data?.categoryId ?? 1);
  const addDescription = category?.addDescription ?? false;
  const addTypes = category?.addTypes ?? false;

  const handleProductUpdate = async (data: TDrink) => {
    await toast.promise(
      updateSingleDrink.mutateAsync(
        {
          id,
          data,
        },
        {
          onSuccess: () => {
            void utils.drinks.getDrinkById.invalidate({ id });
            void router.back();
          },
        }
      ),
      {
        pending: "Pending...",
        success: `Product ${data.title ?? ""} updated`,
        error: "An error occured ðŸ¤¯",
      }
    );
  };

  if (status === "loading") {
    return <Spinner />;
  }

  if (sessionData?.user?.role !== "admin") {
    return <AccessDenied />;
  }

  if (data) {
    return (
      <>
        <Head>
          <title>Edit page | {data.title}</title>
          <meta name="description" content="Generated by create-t3-app" />
          <link rel="icon" href="/favicon.ico" />
        </Head>
        <main className="m-auto max-w-lg flex-col px-4">
          <h1 className="my-5 text-center text-2xl">Edit drink {data.title}</h1>
          <EditDrinkForm
            drink={data}
            onSubmit={handleProductUpdate}
            addDescription={addDescription}
            addTypes={addTypes}
          />
        </main>
      </>
    );
  }

  return <p>Loading...</p>;
};

export default EditDrinkPage;
